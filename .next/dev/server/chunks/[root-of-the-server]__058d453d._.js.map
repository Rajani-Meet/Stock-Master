{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///E:/Stock%20Master/lib/db.ts"],"sourcesContent":["import { PrismaClient } from \"@prisma/client\"\n\nconst globalForPrisma = global as unknown as { prisma: PrismaClient }\n\nexport const db =\n  globalForPrisma.prisma ||\n  new PrismaClient({\n    log: [\"query\", \"error\"],\n  })\n\nif (process.env.NODE_ENV !== \"production\") globalForPrisma.prisma = db\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM;AAEC,MAAM,KACX,gBAAgB,MAAM,IACtB,IAAI,6IAAY,CAAC;IACf,KAAK;QAAC;QAAS;KAAQ;AACzB;AAEF,wCAA2C,gBAAgB,MAAM,GAAG"}},
    {"offset": {"line": 70, "column": 0}, "map": {"version":3,"sources":["file:///E:/Stock%20Master/app/api/dashboard/kpis/route.ts"],"sourcesContent":["import { db } from \"@/lib/db\"\nimport { type NextRequest, NextResponse } from \"next/server\"\n\nexport async function GET(req: NextRequest) {\n  try {\n    const { searchParams } = new URL(req.url)\n    const warehouseId = searchParams.get(\"warehouseId\")\n    const dateFrom = searchParams.get(\"dateFrom\")\n    const dateTo = searchParams.get(\"dateTo\")\n\n    const dateFilter = {}\n    if (dateFrom || dateTo) {\n      dateFilter.createdAt = {}\n      if (dateFrom) dateFilter.createdAt.gte = new Date(dateFrom)\n      if (dateTo) dateFilter.createdAt.lte = new Date(dateTo)\n    }\n\n    // Get total products and inventory value\n    const stockLevels = await db.stockLevel.findMany({\n      where: warehouseId ? { warehouseId } : {},\n      include: { product: true },\n    })\n\n    const totalProducts = stockLevels.filter(sl => sl.quantity > 0).length\n    const totalInventoryValue = stockLevels.reduce((sum, sl) => sum + (sl.quantity * 10), 0) // Assuming avg price\n    const lowStockItems = stockLevels.filter((sl) => sl.quantity > 0 && sl.quantity <= (sl.product.minStockLevel || 10)).length\n    const outOfStockItems = stockLevels.filter((sl) => sl.quantity === 0).length\n\n    // Get pending documents count\n    const [pendingReceipts, pendingDeliveries, scheduledTransfers] = await Promise.all([\n      db.receipt.count({ where: { status: { in: [\"DRAFT\", \"WAITING\"] } } }),\n      db.deliveryOrder.count({ where: { status: { in: [\"DRAFT\", \"READY\"] } } }),\n      db.internalTransfer.count({ where: { status: { in: [\"DRAFT\", \"WAITING\"] } } }),\n    ])\n\n    // Get recent alerts - disabled until schema is updated\n    const recentAlerts = []\n\n    // Get stock movement summary (last 30 days or custom range)\n    const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000)\n    const moveFilter = {\n      createdAt: dateFrom || dateTo ? dateFilter.createdAt : { gte: thirtyDaysAgo },\n      ...(warehouseId && { location: { warehouseId } })\n    }\n\n    const [recentMoves, dailyMovements] = await Promise.all([\n      db.stockMove.groupBy({\n        by: [\"moveType\"],\n        where: moveFilter,\n        _count: true,\n        _sum: { quantity: true }\n      }),\n      db.stockMove.findMany({\n        where: moveFilter,\n        select: {\n          createdAt: true,\n          moveType: true,\n          quantity: true\n        },\n        orderBy: { createdAt: \"desc\" },\n        take: 100\n      })\n    ])\n\n    // Calculate performance metrics\n    const totalMovements = recentMoves.reduce((sum, move) => sum + move._count, 0)\n    const inboundMovements = recentMoves\n      .filter(m => [\"RECEIPT\", \"TRANSFER_IN\", \"ADJUSTMENT_PLUS\"].includes(m.moveType))\n      .reduce((sum, move) => sum + move._count, 0)\n    const outboundMovements = recentMoves\n      .filter(m => [\"DELIVERY\", \"TRANSFER_OUT\", \"ADJUSTMENT_MINUS\"].includes(m.moveType))\n      .reduce((sum, move) => sum + move._count, 0)\n\n    // Group daily movements for trend analysis\n    const movementTrends = dailyMovements.reduce((acc, move) => {\n      const date = move.createdAt.toISOString().split('T')[0]\n      if (!acc[date]) acc[date] = { inbound: 0, outbound: 0 }\n      if ([\"RECEIPT\", \"TRANSFER_IN\", \"ADJUSTMENT_PLUS\"].includes(move.moveType)) {\n        acc[date].inbound += move.quantity\n      } else {\n        acc[date].outbound += move.quantity\n      }\n      return acc\n    }, {})\n\n    return NextResponse.json({\n      inventory: {\n        totalProducts,\n        totalInventoryValue,\n        lowStockItems,\n        outOfStockItems\n      },\n      operations: {\n        pendingReceipts,\n        pendingDeliveries,\n        scheduledTransfers,\n        totalMovements,\n        inboundMovements,\n        outboundMovements\n      },\n      alerts: recentAlerts,\n      trends: {\n        stockMovementSummary: recentMoves,\n        dailyMovements: Object.entries(movementTrends).map(([date, data]) => ({\n          date,\n          ...data\n        })).slice(-7) // Last 7 days\n      }\n    })\n  } catch (error) {\n    console.error(\"Get KPIs error:\", error)\n    return NextResponse.json({ error: \"Failed to fetch KPIs\" }, { status: 500 })\n  }\n}\n"],"names":[],"mappings":"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"}}]
}