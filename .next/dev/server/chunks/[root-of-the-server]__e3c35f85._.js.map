{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///E:/Stock%20Master/lib/db.ts"],"sourcesContent":["import { PrismaClient } from \"@prisma/client\"\n\nconst globalForPrisma = global as unknown as { prisma: PrismaClient }\n\nexport const db =\n  globalForPrisma.prisma ||\n  new PrismaClient({\n    log: [\"query\", \"error\"],\n  })\n\nif (process.env.NODE_ENV !== \"production\") globalForPrisma.prisma = db\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM;AAEC,MAAM,KACX,gBAAgB,MAAM,IACtB,IAAI,6IAAY,CAAC;IACf,KAAK;QAAC;QAAS;KAAQ;AACzB;AAEF,wCAA2C,gBAAgB,MAAM,GAAG"}},
    {"offset": {"line": 70, "column": 0}, "map": {"version":3,"sources":["file:///E:/Stock%20Master/app/api/receipts/route.ts"],"sourcesContent":["import { db } from \"@/lib/db\"\nimport { type NextRequest, NextResponse } from \"next/server\"\n\nexport async function GET(req: NextRequest) {\n  try {\n    const { searchParams } = new URL(req.url)\n    const status = searchParams.get(\"status\")\n    const warehouseId = searchParams.get(\"warehouseId\")\n    const category = searchParams.get(\"category\")\n    const dateFrom = searchParams.get(\"dateFrom\")\n    const dateTo = searchParams.get(\"dateTo\")\n    const skip = parseInt(searchParams.get(\"skip\") || \"0\")\n    const take = parseInt(searchParams.get(\"take\") || \"20\")\n\n    const where: any = {}\n    if (status) where.status = status\n    if (warehouseId) where.warehouseId = warehouseId\n    if (dateFrom || dateTo) {\n      where.receivedDate = {}\n      if (dateFrom) where.receivedDate.gte = new Date(dateFrom)\n      if (dateTo) where.receivedDate.lte = new Date(dateTo)\n    }\n    if (category) {\n      where.items = {\n        some: {\n          product: {\n            categoryId: category\n          }\n        }\n      }\n    }\n\n    const [receipts, total] = await Promise.all([\n      db.receipt.findMany({\n        where,\n        include: {\n          items: { include: { product: true } },\n          warehouse: true,\n        },\n        orderBy: { createdAt: \"desc\" },\n        skip,\n        take,\n      }),\n      db.receipt.count({ where }),\n    ])\n\n    return NextResponse.json({ receipts, total })\n  } catch (error) {\n    console.error(\"Get receipts error:\", error)\n    return NextResponse.json({ error: \"Failed to fetch receipts\" }, { status: 500 })\n  }\n}\n\nexport async function POST(req: NextRequest) {\n  try {\n    const body = await req.json()\n    const { supplierName, warehouseId, receivedDate, items, notes } = body\n\n    if (!supplierName || !warehouseId || !items?.length) {\n      return NextResponse.json({ error: \"Missing required fields\" }, { status: 400 })\n    }\n\n    const receiptNo = `RCP-${Date.now()}`\n\n    const receipt = await db.receipt.create({\n      data: {\n        receiptNo,\n        supplierName,\n        warehouseId,\n        receivedDate: new Date(receivedDate),\n        notes,\n        items: {\n          create: items.map((item: any) => ({\n            productId: item.productId,\n            quantityOrdered: item.quantity,\n            unitPrice: item.unitPrice,\n          })),\n        },\n      },\n      include: { items: { include: { product: true } }, warehouse: true },\n    })\n\n    return NextResponse.json(receipt, { status: 201 })\n  } catch (error) {\n    console.error(\"Create receipt error:\", error)\n    return NextResponse.json({ error: \"Failed to create receipt\" }, { status: 500 })\n  }\n}\n\nexport async function PUT(req: NextRequest) {\n  try {\n    const body = await req.json()\n    const { receiptId, status, items, userId } = body\n\n    if (!receiptId || !userId) {\n      return NextResponse.json({ error: \"Missing receipt ID or user ID\" }, { status: 400 })\n    }\n\n    if (status === \"VALIDATED\") {\n      // Process stock movements\n      const receipt = await db.receipt.findUnique({\n        where: { id: receiptId },\n        include: {\n          items: true,\n          warehouse: true,\n        },\n      })\n\n      if (!receipt) {\n        return NextResponse.json({ error: \"Receipt not found\" }, { status: 404 })\n      }\n\n      // Get default location for warehouse (or use first location)\n      const location = await db.location.findFirst({\n        where: { warehouseId: receipt.warehouseId },\n      })\n\n      if (!location) {\n        return NextResponse.json({ error: \"No location found for warehouse\" }, { status: 400 })\n      }\n\n      // Create or update stock levels for each item\n      for (const item of receipt.items) {\n        const existingStock = await db.stockLevel.findUnique({\n          where: {\n            warehouseId_locationId_productId: {\n              warehouseId: receipt.warehouseId,\n              locationId: location.id,\n              productId: item.productId,\n            },\n          },\n        })\n\n        if (existingStock) {\n          // Update existing stock\n          await db.stockLevel.update({\n            where: { id: existingStock.id },\n            data: {\n              quantity: existingStock.quantity + item.quantityOrdered,\n              availableQuantity: existingStock.availableQuantity + item.quantityOrdered,\n              lastMovedAt: new Date(),\n            },\n          })\n        } else {\n          // Create new stock level\n          await db.stockLevel.create({\n            data: {\n              warehouseId: receipt.warehouseId,\n              locationId: location.id,\n              productId: item.productId,\n              quantity: item.quantityOrdered,\n              availableQuantity: item.quantityOrdered,\n              reservedQuantity: 0,\n            },\n          })\n        }\n\n        // Create stock move record\n        await db.stockMove.create({\n          data: {\n            locationId: location.id,\n            productId: item.productId,\n            moveType: \"RECEIPT\",\n            quantity: item.quantityOrdered,\n            referenceId: receiptId,\n            referenceType: \"Receipt\",\n            notes: `Receipt validation: ${receipt.receiptNo}`,\n          },\n        })\n      }\n\n      // Create audit log\n      await db.auditLog.create({\n        data: {\n          userId,\n          action: \"VALIDATE_RECEIPT\",\n          entityType: \"Receipt\",\n          entityId: receiptId,\n          details: `Validated receipt ${receipt.receiptNo} with ${receipt.items.length} items`,\n        },\n      })\n    }\n\n    const updatedReceipt = await db.receipt.update({\n      where: { id: receiptId },\n      data: { status },\n      include: { items: { include: { product: true } }, warehouse: true },\n    })\n\n    return NextResponse.json(updatedReceipt)\n  } catch (error) {\n    console.error(\"Update receipt error:\", error)\n    return NextResponse.json({ error: \"Failed to update receipt\" }, { status: 500 })\n  }\n}\n\n"],"names":[],"mappings":"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"}}]
}